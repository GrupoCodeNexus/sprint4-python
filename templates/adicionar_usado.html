{% extends "layout.html" %}
{% block title %}Registrar Sa√≠da{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-semibold text-blue-800 flex items-center gap-2">
        ‚ûñ Registrar Sa√≠da de Item
    </h2>
</div>

<form id="form-baixa" class="mb-8 p-4 border border-blue-200 rounded-lg bg-blue-100">
    <div class="mb-4">
        <label for="paciente" class="block text-gray-700 text-sm font-bold mb-2">Nome do Paciente:</label>
        <input type="text" id="paciente" name="paciente"
               class="w-full p-3 border-2 border-blue-400 rounded-lg focus:outline-none"
               placeholder="Ex: Ana Oliveira" required />
    </div>
    <div class="mb-4">
        <label for="codigo" class="block text-gray-700 text-sm font-bold mb-2">C√≥digo ou Nome do Item:</label>
        <input type="text" id="codigo" name="codigo" autofocus
               class="w-full p-3 border-2 border-blue-400 rounded-lg focus:outline-none"
               placeholder="Digite o c√≥digo (ex: MED001) ou nome (ex: Paracetamol)..."
               list="sugestoes-itens" required />
        <datalist id="sugestoes-itens"></datalist>
    </div>
    <div class="mb-4">
        <label for="tipo_saida" class="block text-gray-700 text-sm font-bold mb-2">Tipo de Sa√≠da:</label>
        <select id="tipo_saida" name="tipo_saida"
                class="w-full p-3 border-2 border-blue-400 rounded-lg focus:outline-none" required>
            <option value="">Selecione o Tipo</option>
            <option value="Unidade">Unidade</option>
            <option value="mg">mg</option>
            <option value="g">g</option>
            <option value="ml">ml</option>
            <option value="L">L</option>
            <option value="Caixa">Caixa</option>
            <option value="Ampola">Ampola</option>
            <option value="Frasco">Frasco</option>
        </select>
    </div>
    <button type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded shadow w-full">
        ‚ûï Registrar Sa√≠da
    </button>
</form>

<h3 class="text-xl font-semibold text-blue-700 mb-2 mt-8">üìã Hist√≥rico de Sa√≠das Recentes</h3>
{% if historico %}
<table class="w-full table-auto border border-gray-300 rounded-lg bg-white text-sm">
    <thead class="bg-blue-100">
        <tr>
            <th class="px-4 py-2 border">Hor√°rio</th>
            <th class="px-4 py-2 border">Item</th>
            <th class="px-4 py-2 border">Tipo</th>
            <th class="px-4 py-2 border">Paciente</th>
            <th class="px-4 py-2 border">A√ß√µes</th> {# NOVA COLUNA PARA A√á√ïES #}
        </tr>
    </thead>
    <tbody id="tabela-itens">
        {% for item in historico|reverse %}
        <tr id="item-{{ item.id }}"> {# Adicionado ID para facilitar remo√ß√£o/edi√ß√£o via JS #}
            <td class="border px-4 py-2">{{ item.hora }}</td>
            <td class="border px-4 py-2">{{ item.item }}</td>
            <td class="border px-4 py-2">{{ item.tipo if item.tipo else 'N/A' }}</td>
            <td class="border px-4 py-2">{{ item.paciente }}</td>
            <td class="border px-4 py-2 text-center">
                <button onclick="editarItem('{{ item.id }}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs mr-2">Editar</button>
                <button onclick="removerItem('{{ item.id }}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs">Remover</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-gray-500" id="no-items-message">Nenhum item foi registrado ainda.</p>
{% endif %}

<div class="mt-6 flex justify-center gap-4">
    <button id="gerar-relatorio" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded shadow">Gerar Relat√≥rio</button>
    <a href="#" id="b" class="bg-green-300 text-white px-6 py-2 rounded shadow hover:bg-green-400">Baixar Relat√≥rio</a>
</div>

<!--Logo parceiros-->
<div class="flex justify-center items-center mt-8 mb-0">
  <img src="../static/assets/logoParceiros.png" alt="logo-parceiros" class="w-40 h-auto object-contain" />
</div>

<!--rodap√©-->
<footer class="bg-sabaraBlue text-white p-4 flex justify-between items-center shadow-md">
  <p class="text-sm">&copy; 2025 Hospital Sabar√°</p>
  <div class="flex space-x-4 text-sm sm:text-base">
    <a href="#" class="transition duration-300 hover:text-yellow-200">Contato</a>
    <a href="#" class="transition duration-300 hover:text-yellow-200">Ajuda</a>
  </div>
</footer>

{# Alerta do carrinho via Socket.IO - Este div pode permanecer aqui #}
<div id="alerta-carrinho" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative m-4 text-center transition-all duration-500">
    Alerta do carrinho aqui.
</div>

{# Modal de Edi√ß√£o (Adicionado) #}
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-96">
        <h3 class="text-xl font-semibold mb-4">Editar Registro de Sa√≠da</h3>
        <form id="editForm">
            <input type="hidden" id="editItemId">
            <div class="mb-4">
                <label for="editPaciente" class="block text-gray-700 text-sm font-bold mb-2">Paciente:</label>
                <input type="text" id="editPaciente" class="w-full p-2 border border-gray-300 rounded" required>
            </div>
            <div class="mb-4">
                <label for="editItem" class="block text-gray-700 text-sm font-bold mb-2">Item:</label>
                <input type="text" id="editItem" class="w-full p-2 border border-gray-300 rounded" required>
            </div>
            <div class="mb-4">
                <label for="editTipo" class="block text-gray-700 text-sm font-bold mb-2">Tipo:</label>
                <select id="editTipo" class="w-full p-2 border border-gray-300 rounded" required>
                    <option value="Unidade">Unidade</option>
                    <option value="mg">mg</option>
                    <option value="g">g</option>
                    <option value="ml">ml</option>
                    <option value="L">L</option>
                    <option value="Caixa">Caixa</option>
                    <option value="Ampola">Ampola</option>
                    <option value="Frasco">Frasco</option>
                </select>
            </div>
            <div class="flex justify-end">
                <button type="button" onclick="salvarEdicao()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mr-2">Salvar</button>
                <button type="button" onclick="fecharModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Cancelar</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %} {# O JavaScript desta p√°gina agora est√° dentro do block scripts #}
<script>
    // Inicializa√ß√£o do Socket.IO
    const socket = io();
    socket.on("carrinho_aberto", data => {
        const alerta = document.getElementById("alerta-carrinho");
        if (alerta) {
            alerta.textContent = `üö® Carrinho aberto por ${data.responsavel} √†s ${data.hora}`;
            alerta.classList.remove("hidden");
            setTimeout(() => alerta.classList.add("hidden"), 10000);
        }
    });

    // Fun√ß√£o para carregar sugest√µes de itens para autocompletar
    async function carregarSugestoesItens() {
        try {
            const response = await fetch("/api/itens_nomes");
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const nomes = await response.json();
            const datalist = document.getElementById("sugestoes-itens");
            if (datalist) {
                datalist.innerHTML = "";
                nomes.forEach(nome => {
                    const option = document.createElement("option");
                    option.value = nome;
                    datalist.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Erro ao carregar sugest√µes de itens:", error);
        }
    }

    document.addEventListener("DOMContentLoaded", carregarSugestoesItens);

    // Fun√ß√£o para dar baixa em item (registrar item usado)
    document.getElementById("form-baixa").addEventListener("submit", async (e) => {
        e.preventDefault();
        const codigo = document.getElementById("codigo").value;
        const paciente = document.getElementById("paciente").value;
        const tipoSaida = document.getElementById("tipo_saida").value;

        if (!codigo || !paciente || !tipoSaida) {
            alert("Por favor, preencha o nome do paciente, o c√≥digo/nome do item e selecione o tipo.");
            return;
        }

        const formData = new FormData();
        formData.append("codigo", codigo);
        formData.append("paciente", paciente);
        formData.append("tipo", tipoSaida);

        console.log("Enviando requisi√ß√£o /scan...");
        try {
            const res = await fetch("/scan", {
                method: "POST",
                body: formData
            });

            const data = await res.json();
            console.log("Resposta de /scan:", data);

            if (data.success) {
                alert(`‚úÖ Item "${data.item}" (${data.tipo ? data.tipo : 'N/A'}) registrado para paciente "${data.paciente}"`);

                let tabelaItens = document.getElementById("tabela-itens");
                const noItemsMessage = document.getElementById("no-items-message");

                if (!tabelaItens || !document.querySelector('table')) {
                    console.log("Tabela de hist√≥rico n√£o encontrada. Criando a estrutura da tabela...");
                    if (noItemsMessage) {
                        noItemsMessage.remove();
                    }

                    const historicoH3 = document.querySelector('h3.text-blue-700.mb-2.mt-8');
                    if (historicoH3) {
                        const newTableHtml = `
                            <table class="w-full table-auto border border-gray-300 rounded-lg bg-white text-sm">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="px-4 py-2 border">Hor√°rio</th>
                                        <th class="px-4 py-2 border">Item</th>
                                        <th class="px-4 py-2 border">Tipo</th>
                                        <th class="px-4 py-2 border">Paciente</th>
                                        <th class="px-4 py-2 border">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-itens">
                                </tbody>
                            </table>
                        `;
                        historicoH3.insertAdjacentHTML('afterend', newTableHtml);
                        tabelaItens = document.getElementById("tabela-itens");
                        console.log("Tabela e tbody criados:", tabelaItens);
                    } else {
                        console.error("Erro: N√£o foi poss√≠vel encontrar o elemento H3 para inserir a tabela de hist√≥rico.");
                        alert("Erro interno: n√£o foi poss√≠vel exibir o item no hist√≥rico.");
                        return;
                    }
                } else {
                    console.log("tabela-itens j√° existe:", tabelaItens);
                }

                if (tabelaItens) {
                    const tr = document.createElement("tr");
                    tr.id = `item-${data.id}`;
                    tr.innerHTML = `
                        <td class="border px-4 py-2">${data.hora}</td>
                        <td class="border px-4 py-2">${data.item}</td>
                        <td class="border px-4 py-2">${data.tipo ? data.tipo : 'N/A'}</td>
                        <td class="border px-4 py-2">${data.paciente ? data.paciente : 'N/A'}</td>
                        <td class="border px-4 py-2 text-center">
                            <button onclick="editarItem('${data.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs mr-2">Editar</button>
                            <button onclick="removerItem('${data.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs">Remover</button>
                        </td>
                    `;
                    tabelaItens.prepend(tr);
                    console.log("Linha adicionada ao hist√≥rico.");
                } else {
                    console.error("Erro: Tabela de hist√≥rico (tbody) n√£o encontrada ap√≥s tentativa de cria√ß√£o.");
                    alert("Erro interno: n√£o foi poss√≠vel adicionar o item ao hist√≥rico visual.");
                }

                document.getElementById("paciente").value = "";
                document.getElementById("codigo").value = "";
                document.getElementById("tipo_saida").value = "";
                document.getElementById("paciente").focus();
            } else {
                alert("‚ùå " + data.mensagem);
            }
        } catch (error) {
            console.error("Erro na requisi√ß√£o /scan:", error);
            alert("Erro de comunica√ß√£o ao registrar item.");
        }
    });

    // Fun√ß√µes para gerar e baixar relat√≥rio
    document.getElementById("gerar-relatorio").addEventListener("click", async () => {
        try {
            const res = await fetch("/gerar_relatorio", { method: "POST" });
            const data = await res.json();
            if (data.success) {
                alert("Relat√≥rio gerado com sucesso. Voc√™ pode baix√°-lo agora.");
            } else {
                alert(data.mensagem);
            }
        } catch (error) {
            console.error("Erro na requisi√ß√£o de gera√ß√£o de relat√≥rio:", error);
            alert("Erro de comunica√ß√£o ao gerar relat√≥rio.");
        }
    });

    // --- Fun√ß√µes de Edi√ß√£o e Remo√ß√£o ---

    // Abre o modal de edi√ß√£o
    async function editarItem(id) {
        try {
            const response = await fetch(`/api/historico/${id}`);
            if (!response.ok) {
                // Tenta ler a mensagem de erro do servidor se dispon√≠vel
                const errorData = await response.json().catch(() => ({ message: `Erro HTTP ${response.status}` }));
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message}`);
            }
            const item = await response.json();

            document.getElementById('editItemId').value = id;
            document.getElementById('editPaciente').value = item.paciente || '';
            document.getElementById('editItem').value = item.item || '';
            document.getElementById('editTipo').value = item.tipo || '';

            document.getElementById('editModal').classList.remove('hidden');
        } catch (error) {
            console.error("Erro ao carregar dados para edi√ß√£o:", error);
            alert("Erro ao carregar dados para edi√ß√£o: " + error.message);
        }
    }

    // Fecha o modal de edi√ß√£o
    function fecharModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    // Salva as edi√ß√µes de um item
    async function salvarEdicao() {
        const id = document.getElementById('editItemId').value;
        const paciente = document.getElementById('editPaciente').value;
        const item = document.getElementById('editItem').value;
        const tipo = document.getElementById('editTipo').value;

        const formData = new FormData();
        formData.append('id', id); // √â bom enviar o ID no FormData tamb√©m, embora j√° esteja na URL
        formData.append('paciente', paciente);
        formData.append('item', item);
        formData.append('tipo', tipo);

        try {
            const response = await fetch(`/api/historico/${id}`, {
                method: 'PUT',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                alert("Item atualizado com sucesso!");
                fecharModal();
                // Atualizar a linha na tabela visualmente
                const row = document.getElementById(`item-${id}`);
                if (row) {
                    row.children[1].textContent = item;
                    row.children[2].textContent = tipo;
                    row.children[3].textContent = paciente;
                }
            } else {
                alert("Erro ao atualizar item: " + data.message);
            }
        } catch (error) {
            console.error("Erro na requisi√ß√£o de edi√ß√£o:", error);
            alert("Erro de comunica√ß√£o ao salvar edi√ß√£o.");
        }
    }

    // Remove um item
    async function removerItem(id) {
        if (confirm("Tem certeza que deseja remover este registro?")) {
            try {
                const response = await fetch(`/api/historico/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    alert("Item removido com sucesso!");
                    const row = document.getElementById(`item-${id}`);
                    if (row) {
                        row.remove();
                    }
                    // Verifica se a tabela ficou vazia ap√≥s a remo√ß√£o
                    if (document.getElementById("tabela-itens").rows.length === 0) {
                        const historicoH3 = document.querySelector('h3.text-blue-700.mb-2.mt-8');
                        if (historicoH3 && !document.getElementById("no-items-message")) {
                            const p = document.createElement('p');
                            p.id = "no-items-message";
                            p.className = "text-gray-500";
                            p.textContent = "Nenhum item foi registrado ainda.";
                            historicoH3.insertAdjacentElement('afterend', p);
                        }
                        const tableElement = document.querySelector('table');
                        if (tableElement) {
                             tableElement.remove(); // Remove a tabela completa
                        }
                    }
                } else {
                    alert("Erro ao remover item: " + data.message);
                }
            } catch (error) {
                console.error("Erro na requisi√ß√£o de remo√ß√£o:", error);
                alert("Erro de comunica√ß√£o ao remover item.");
            }
        }
    }
</script>
{% endblock %}
