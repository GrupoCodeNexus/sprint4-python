{% extends "layout.html" %}
{% block title %}Registrar Sa√≠da{% endblock %} {# T√≠tulo mais claro para a fun√ß√£o da p√°gina #}

{% block content %}
<div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-semibold text-blue-800 flex items-center gap-2">
        ‚ûñ Registrar Sa√≠da de Item
    </h2>
</div>

<form id="form-baixa" class="mb-8 p-4 border border-blue-200 rounded-lg bg-blue-100">
    <div class="mb-4">
        <label for="paciente" class="block text-gray-700 text-sm font-bold mb-2">Nome do Paciente:</label>
        <input type="text" id="paciente" name="paciente"
               class="w-full p-3 border-2 border-blue-400 rounded-lg focus:outline-none"
               placeholder="Ex: Ana Oliveira" required />
    </div>
    <div class="mb-4">
        <label for="codigo" class="block text-gray-700 text-sm font-bold mb-2">C√≥digo ou Nome do Item:</label>
        <input type="text" id="codigo" name="codigo" autofocus
               class="w-full p-3 border-2 border-blue-400 rounded-lg focus:outline-none"
               placeholder="Digite o c√≥digo (ex: MED001) ou nome (ex: Paracetamol)..."
               list="sugestoes-itens" required /> {# Adicionado list attribute para datalist #}
        <datalist id="sugestoes-itens"></datalist> {# Datalist para autocompletar #}
    </div>
    {# NOVO CAMPO: TIPO #}
    <div class="mb-4">
        <label for="tipo_saida" class="block text-gray-700 text-sm font-bold mb-2">Tipo de Sa√≠da:</label>
        <select id="tipo_saida" name="tipo_saida"
                class="w-full p-3 border-2 border-blue-400 rounded-lg focus:outline-none" required>
            <option value="">Selecione o Tipo</option>
            <option value="Unidade">Unidade</option>
            <option value="mg">mg</option>
            <option value="g">g</option>
            <option value="ml">ml</option>
            <option value="L">L</option>
            <option value="Caixa">Caixa</option>
            <option value="Ampola">Ampola</option>
            <option value="Frasco">Frasco</option>
        </select>
    </div>
    <button type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded shadow w-full">
        ‚ûï Registrar Sa√≠da
    </button>
</form>

<h3 class="text-xl font-semibold text-blue-700 mb-2 mt-8">üìã Hist√≥rico de Sa√≠das Recentes</h3>
{% if historico %}
<table class="w-full table-auto border border-gray-300 rounded-lg bg-white text-sm">
    <thead class="bg-blue-100">
        <tr>
            <th class="px-4 py-2 border">Hor√°rio</th>
            <th class="px-4 py-2 border">Item</th>
            <th class="px-4 py-2 border">Tipo</th> {# NOVA COLUNA: TIPO #}
            <th class="px-4 py-2 border">Paciente</th>
            <th class="px-4 py-2 border">A√ß√£o</th>
        </tr>
    </thead>
    <tbody id="tabela-itens">
        {% for item in historico|reverse %}
        <tr data-index="{{ loop.index0 }}"> {# Atributo data-index mantido para refer√™ncia do JS #}
            <td class="border px-4 py-2">{{ item.hora }}</td>
            <td class="border px-4 py-2">{{ item.item }}</td>
            <td class="border px-4 py-2">{{ item.tipo if item.tipo else 'N/A' }}</td>
            <td class="border px-4 py-2">{{ item.paciente }}</td>
            <td class="border px-4 py-2 text-center"> {# CORRIGIDO: APENAS UMA TAG TD AQUI #}
                <button class="text-blue-600 hover:underline editar-btn" data-index="{{ loop.index0 }}">Editar</button> |
                <button class="text-red-600 hover:underline remover-btn" data-index="{{ loop.index0 }}">Remover</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-gray-500" id="no-items-message">Nenhum item foi registrado ainda.</p>
{% endif %}

<div class="mt-6 flex justify-center gap-4">
    <button id="gerar-relatorio" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded shadow">Gerar Relat√≥rio</button>
    <a href="#" id="b" class="bg-green-300 text-white px-6 py-2 rounded shadow hover:bg-green-400">Baixar Relat√≥rio</a>
</div>

<!--Logo parceiros-->
<div class="flex justify-center items-center mt-8 mb-0">
    <img src="../static/assets/logoParceiros.png" alt="logo-parceiros" class="w-40 h-auto object-contain" />
</div>

<!--rodap√©-->
<footer class="bg-sabaraBlue text-white p-4 flex justify-between items-center shadow-md">
    <p class="text-sm">&copy; 2025 Hospital Sabar√°</p>
    <div class="flex space-x-4 text-sm sm:text-base">
        <a href="#" class="transition duration-300 hover:text-yellow-200">Contato</a>
        <a href="#" class="transition duration-300 hover:text-yellow-200">Ajuda</a>
    </div>
</footer>

{# Alerta do carrinho via Socket.IO - Este div pode permanecer aqui #}
<div id="alerta-carrinho" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative m-4 text-center transition-all duration-500">
    Alerta do carrinho aqui.
</div>

<!-- Modal de Edi√ß√£o (NOVO) -->
<div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50"> {# z-50 para garantir que fique por cima #}
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h3 class="text-xl font-semibold text-blue-700 mb-4">Editar Registro de Sa√≠da</h3>
        <form id="form-edit-historico">
            <input type="hidden" id="edit-index">
            <div class="mb-4">
                <label for="edit-item-codigo" class="block text-gray-700 text-sm font-bold mb-2">C√≥digo ou Nome do Item:</label>
                <input type="text" id="edit-item-codigo" name="codigo"
                       class="w-full p-3 border-2 border-blue-400 rounded-lg focus:outline-none"
                       placeholder="Digite o c√≥digo (ex: MED001) ou nome (ex: Paracetamol)..."
                       list="sugestoes-itens-edit" required />
                <datalist id="sugestoes-itens-edit"></datalist>
            </div>
            <div class="mb-4">
                <label for="edit-paciente" class="block text-gray-700 text-sm font-bold mb-2">Nome do Paciente:</label>
                <input type="text" id="edit-paciente" name="paciente"
                       class="w-full p-3 border-2 border-blue-400 rounded-lg focus:outline-none"
                       placeholder="Ex: Ana Oliveira" required />
            </div>
            <div class="mb-4">
                <label for="edit-tipo" class="block text-gray-700 text-sm font-bold mb-2">Tipo de Sa√≠da:</label>
                <select id="edit-tipo" name="tipo"
                        class="w-full p-3 border-2 border-blue-400 rounded-lg focus:outline-none" required>
                    <option value="">Selecione o Tipo</option>
                    <option value="Unidade">Unidade</option>
                    <option value="mg">mg</option>
                    <option value="g">g</option>
                    <option value="ml">ml</option>
                    <option value="L">L</option>
                    <option value="Caixa">Caixa</option>
                    <option value="Ampola">Ampola</option>
                    <option value="Frasco">Frasco</option>
                </select>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-edit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded shadow">Cancelar</button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">Salvar Altera√ß√µes</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %} {# O JavaScript desta p√°gina agora est√° dentro do block scripts #}
<script>
    // Vari√°veis e Seletores para o Modal de Edi√ß√£o (movidos para o topo do script para melhor escopo)
    const editModal = document.getElementById('edit-modal');
    const formEditHistorico = document.getElementById('form-edit-historico');
    const editIndexInput = document.getElementById('edit-index');
    const editItemCodigoInput = document.getElementById('edit-item-codigo');
    const editPacienteInput = document.getElementById('edit-paciente');
    const editTipoSelect = document.getElementById('edit-tipo');
    const cancelEditButton = document.getElementById('cancel-edit');

    // Inicializa√ß√£o do Socket.IO
    const socket = io();
    socket.on("carrinho_aberto", data => {
        const alerta = document.getElementById("alerta-carrinho");
        if (alerta) {
            alerta.textContent = `üö® Carrinho aberto por ${data.responsavel} √†s ${data.hora}`;
            alerta.classList.remove("hidden");
            setTimeout(() => alerta.classList.add("hidden"), 10000);
        }
    });

    // --- L√≥gica de Edi√ß√£o do Hist√≥rico ---
    // Abre o modal de edi√ß√£o e preenche os campos
    async function openEditModal(index) {
        try {
            const response = await fetch(`/get_history_item/${index}`);
            const data = await response.json();

            if (data.success) {
                editIndexInput.value = index;
                editItemCodigoInput.value = data.item;
                editPacienteInput.value = data.paciente;
                editTipoSelect.value = data.tipo;
                editModal.classList.remove('hidden');
            } else {
                alert("Erro ao carregar dados do item para edi√ß√£o: " + data.mensagem);
            }
        } catch (error) {
            console.error("Erro ao buscar item hist√≥rico para edi√ß√£o:", error);
            alert("Erro de comunica√ß√£o ao tentar carregar dados para edi√ß√£o.");
        }
    }

    // Fecha o modal de edi√ß√£o
    function closeEditModal() {
        editModal.classList.add('hidden');
        formEditHistorico.reset(); // Limpa campos do modal ao fechar
    }

    // Evento de submit do formul√°rio de edi√ß√£o
    formEditHistorico.addEventListener('submit', async (e) => {
        e.preventDefault();
        const index = editIndexInput.value;
        const codigo = editItemCodigoInput.value;
        const paciente = editPacienteInput.value;
        const tipo = editTipoSelect.value;

        if (!codigo || !paciente || !tipo) {
            alert("Por favor, preencha todos os campos para editar.");
            return;
        }

        const formData = new FormData();
        formData.append('index', index);
        formData.append('codigo', codigo);
        formData.append('paciente', paciente);
        formData.append('tipo', tipo);

        try {
            const response = await fetch('/edit_history_item', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                alert('‚úÖ Registro atualizado com sucesso!');
                // Atualizar a linha na tabela HTML
                const row = document.querySelector(`tr[data-index="${index}"]`);
                if (row) {
                    row.children[0].textContent = data.hora;
                    row.children[1].textContent = data.item;
                    row.children[2].textContent = data.tipo;
                    row.children[3].textContent = data.paciente;
                }
                closeEditModal();
            } else {
                alert('‚ùå Erro ao atualizar registro: ' + data.mensagem);
            }
        } catch (error) {
            console.error("Erro ao enviar edi√ß√£o:", error);
            alert("Erro de comunica√ß√£o ao tentar salvar as altera√ß√µes.");
        }
    });

    // Evento de clique para cancelar edi√ß√£o
    cancelEditButton.addEventListener('click', closeEditModal);

    // --- L√≥gica de Remo√ß√£o do Hist√≥rico ---
    async function deleteHistoryItem(index, rowElement) {
        if (confirm("Tem certeza que deseja remover este registro do hist√≥rico? Esta a√ß√£o √© irrevers√≠vel.")) {
            const formData = new FormData();
            formData.append('index', index);

            try {
                const response = await fetch('/delete_history_item', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    alert('üóëÔ∏è ' + data.mensagem);
                    // Remover a linha da tabela
                    if (rowElement) {
                        rowElement.remove();
                    }
                    // Se n√£o houver mais itens, mostrar a mensagem "Nenhum item..."
                    const currentRows = document.querySelectorAll('#tabela-itens tr');
                    if (currentRows.length === 0) {
                        const historicoH3 = document.querySelector('h3.text-blue-700.mb-2.mt-8');
                        const table = document.querySelector('table.table-auto');

                        if (historicoH3) {
                            const newP = document.createElement('p');
                            newP.id = 'no-items-message';
                            newP.className = 'text-gray-500';
                            newP.textContent = 'Nenhum item foi registrado ainda.';
                            historicoH3.insertAdjacentElement('afterend', newP);
                        }
                        if (table) {
                            table.remove();
                        }
                    }
                } else {
                    alert('‚ùå Erro ao remover registro: ' + data.mensagem);
                }
            } catch (error) {
                console.error("Erro ao enviar remo√ß√£o:", error);
                alert("Erro de comunica√ß√£o ao tentar remover o registro.");
            }
        }
    }

    // Fun√ß√£o para carregar sugest√µes de itens para autocompletar
    async function carregarSugestoesItens() {
        try {
            const response = await fetch("/api/itens_nomes");
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const nomes = await response.json();
            const datalist = document.getElementById("sugestoes-itens"); // Para o campo de entrada principal
            const datalistEdit = document.getElementById("sugestoes-itens-edit"); // Para o modal de edi√ß√£o

            if (datalist) {
                datalist.innerHTML = ""; // Limpa sugest√µes antigas
                nomes.forEach(nome => {
                    const option = document.createElement("option");
                    option.value = nome;
                    datalist.appendChild(option);
                });
            }
            // Corrigido: datalistEdit agora est√° definida e √© populada
            if (datalistEdit) {
                datalistEdit.innerHTML = "";
                nomes.forEach(nome => {
                    const option = document.createElement("option");
                    option.value = nome;
                    datalistEdit.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Erro ao carregar sugest√µes de itens:", error);
        }
    }

    // Chama a fun√ß√£o para carregar sugest√µes ao carregar a p√°gina
    document.addEventListener("DOMContentLoaded", carregarSugestoesItens);

    // Fun√ß√£o para dar baixa em item (registrar item usado)
    document.getElementById("form-baixa").addEventListener("submit", async (e) => {
        e.preventDefault();
        const codigo = document.getElementById("codigo").value;
        const paciente = document.getElementById("paciente").value;
        const tipoSaida = document.getElementById("tipo_saida").value;

        if (!codigo || !paciente || !tipoSaida) {
            alert("Por favor, preencha o nome do paciente, o c√≥digo/nome do item e selecione o tipo.");
            return;
        }

        const formData = new FormData();
        formData.append("codigo", codigo);
        formData.append("paciente", paciente);
        formData.append("tipo", tipoSaida);

        console.log("Enviando requisi√ß√£o /scan...");
        const res = await fetch("/scan", {
            method: "POST",
            body: formData
        });

        const data = await res.json();
        console.log("Resposta de /scan:", data);

        if (data.success) {
            alert(`‚úÖ Item "${data.item}" (${data.tipo ? data.tipo : 'N/A'}) registrado para paciente "${data.paciente}"`);

            let tabelaItens = document.getElementById("tabela-itens");
            const noItemsMessage = document.getElementById("no-items-message");

            // Se a tabela tbody n√£o existe (porque historico estava vazio inicialmente), crie a estrutura completa da tabela
            if (!tabelaItens || tabelaItens.children.length === 0) { // Verifica se tabelaItens est√° vazia ou n√£o existe
                console.log("tabela-itens n√£o encontrada ou vazia. Criando a estrutura da tabela...");
                if (noItemsMessage) {
                    noItemsMessage.remove(); // Remove a mensagem "Nenhum item..."
                }

                const historicoH3 = document.querySelector('h3.text-blue-700.mb-2.mt-8');
                if (historicoH3) {
                    const newTableHtml = `
                        <table class="w-full table-auto border border-gray-300 rounded-lg bg-white text-sm">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="px-4 py-2 border">Hor√°rio</th>
                                    <th class="px-4 py-2 border">Item</th>
                                    <th class="px-4 py-2 border">Tipo</th>
                                    <th class="px-4 py-2 border">Paciente</th>
                                    <th class="px-4 py-2 border">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-itens">
                            </tbody>
                        </table>
                    `;
                    historicoH3.insertAdjacentHTML('afterend', newTableHtml);
                    tabelaItens = document.getElementById("tabela-itens"); // Re-obtem a refer√™ncia ao novo tbody
                    console.log("Tabela e tbody criados:", tabelaItens);
                } else {
                    console.error("Erro: N√£o foi poss√≠vel encontrar o elemento H3 para inserir a tabela de hist√≥rico.");
                    alert("Erro interno: n√£o foi poss√≠vel exibir o item no hist√≥rico.");
                    return;
                }
            } else {
                console.log("tabela-itens j√° existe:", tabelaItens);
            }

            // Adiciona a nova linha ao in√≠cio do tbody
            if (tabelaItens) {
                const newRow = document.createElement("tr");
                // Importante: `data.index` deve vir do backend com o √≠ndice correto.
                // Se o backend n√£o retornar, um recarregamento da p√°gina seria mais robusto
                // para garantir que os `data-index` de todos os itens estejam corretos.
                // Aqui, usamos um fallback tempor√°rio, mas o ideal √© que o backend forne√ßa.
                newRow.setAttribute('data-index', data.index !== undefined ? data.index : (tabelaItens.children.length));

                newRow.innerHTML = `
                    <td class="border px-4 py-2">${data.hora}</td>
                    <td class="border px-4 py-2">${data.item}</td>
                    <td class="border px-4 py-2">${data.tipo ? data.tipo : 'N/A'}</td>
                    <td class="border px-4 py-2">${data.paciente ? data.paciente : 'N/A'}</td>
                    <td class="border px-4 py-2 text-center">
                        <button class="text-blue-600 hover:underline editar-btn" data-index="${newRow.getAttribute('data-index')}">Editar</button> |
                        <button class="text-red-600 hover:underline remover-btn" data-index="${newRow.getAttribute('data-index')}">Remover</button>
                    </td>
                `;
                tabelaItens.prepend(newRow); // Adiciona a nova linha no in√≠cio da tabela
                console.log("Linha adicionada ao hist√≥rico.");

                // Reatachar event listeners para os novos bot√µes!
                attachHistoryEventListeners();

                // Esconder a mensagem "Nenhum item..." se estiver vis√≠vel
                if (noItemsMessage && !noItemsMessage.classList.contains("hidden")) {
                    noItemsMessage.classList.add("hidden");
                }

            } else {
                console.error("Erro: Tabela de hist√≥rico (tbody) n√£o encontrada ap√≥s tentativa de cria√ß√£o.");
                alert("Erro interno: n√£o foi poss√≠vel adicionar o item ao hist√≥rico visual.");
            }

            document.getElementById("paciente").value = "";
            document.getElementById("codigo").value = "";
            document.getElementById("tipo_saida").value = ""; // Limpa o campo tipo
            document.getElementById("paciente").focus();
        } else {
            alert("‚ùå " + data.mensagem);
        }
    });

    // Fun√ß√µes para anexar os event listeners aos bot√µes de a√ß√£o (MOVIDA PARA FORA DE OUTRAS FUN√á√ïES)
    // Definidas uma √∫nica vez para serem acess√≠veis globalmente.
    function attachHistoryEventListeners() {
        // Remover listeners antigos para evitar duplica√ß√£o
        document.querySelectorAll('.editar-btn').forEach(button => {
            button.removeEventListener('click', handleEditClick); // Importante para evitar m√∫ltiplos listeners na mesma fun√ß√£o
            button.addEventListener('click', handleEditClick);
        });

        document.querySelectorAll('.remover-btn').forEach(button => {
            button.removeEventListener('click', handleRemoveClick); // Importante para evitar m√∫ltiplos listeners na mesma fun√ß√£o
            button.addEventListener('click', handleRemoveClick);
        });
    }

    // Handlers separados para reuso com removeEventListener (MOVIDOS PARA FORA DE OUTRAS FUN√á√ïES)
    // Definidos uma √∫nica vez para serem acess√≠veis globalmente.
    function handleEditClick(e) {
        e.preventDefault();
        const index = parseInt(e.target.dataset.index);
        openEditModal(index);
    }

    function handleRemoveClick(e) {
        e.preventDefault();
        const index = parseInt(e.target.dataset.index);
        const rowElement = e.target.closest('tr');
        deleteHistoryItem(index, rowElement);
    }

    // Chama a fun√ß√£o para anexar listeners quando a p√°gina carrega (Apenas UMA vez no DOMContentLoaded)
    document.addEventListener("DOMContentLoaded", attachHistoryEventListeners);


    // Fun√ß√µes para gerar e baixar relat√≥rio
    document.getElementById("gerar-relatorio").addEventListener("click", async () => {
        const res = await fetch("/gerar_relatorio", { method: "POST" });
        const data = await res.json();
        if (data.success) {
            alert("Relat√≥rio gerado com sucesso. Voc√™ pode baix√°-lo agora.");
        } else {
            alert(data.mensagem);
        }
    });

    document.getElementById("b").addEventListener("click", async (e) => {
        e.preventDefault();
        try {
            const response = await fetch("/baixar_relatorio");
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'relatorio_saida.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } else {
                alert("Erro ao baixar o relat√≥rio. Talvez nenhum relat√≥rio tenha sido gerado ainda.");
            }
        } catch (error) {
            console.error("Erro ao baixar relat√≥rio:", error);
            alert("Erro de comunica√ß√£o ao tentar baixar o relat√≥rio.");
        }
    });

</script>
{% endblock %}
