<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Carrinho Médico</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body class="bg-blue-50 text-gray-800">

  <nav class="bg-blue-700 text-white px-6 py-4 flex justify-between items-center shadow">
    <h1 class="text-xl font-bold">Carrinho Médico</h1>
    <div class="space-x-4">
      <a href="/" class="hover:underline">Dar Baixa</a>
      <a href="/estoque" class="hover:underline">Estoque</a>
    </div>
  </nav>

  <!-- ALERTA SOCKET.IO -->
  <div id="alerta-carrinho" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative m-4 text-center transition-all duration-500">
    Alerta do carrinho aqui.
  </div>

  <main class="max-w-2xl mx-auto mt-6 p-6 bg-white rounded shadow">
    <h2 class="text-2xl font-semibold mb-4 flex items-center gap-2">
      <span>🔄</span> Dar Baixa por Código
    </h2>

    <form id="form-baixa" class="mb-6">
      <input type="text" id="codigo" name="codigo" autofocus
             class="w-full p-4 border-2 border-blue-400 rounded-lg focus:outline-none"
             placeholder="Escaneie o código do item..." />
    </form>

    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-200 rounded">
        <thead>
          <tr class="bg-blue-600 text-white">
            <th class="py-2 px-4 text-left">Data/Hora</th>
            <th class="py-2 px-4 text-left">Item</th>
          </tr>
        </thead>
        <tbody id="tabela-itens">
          {% for item in itens %}
            <tr class="border-t">
              <td class="py-2 px-4">{{ item.hora }}</td>
              <td class="py-2 px-4">{{ item.item }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-6 flex justify-center gap-4">
      <button id="gerar-relatorio" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded shadow">Gerar Relatório</button>
      <a href="/baixar_relatorio" id="baixar-relatorio" class="bg-green-300 text-white px-6 py-2 rounded shadow hover:bg-green-400">Baixar Relatório</a>
    </div>
  </main>

  <script>
    const socket = io();
    socket.on("carrinho_aberto", data => {
      const alerta = document.getElementById("alerta-carrinho");
      alerta.textContent = `🚨 Carrinho aberto por ${data.responsavel} às ${data.hora}`;
      alerta.classList.remove("hidden");
      setTimeout(() => alerta.classList.add("hidden"), 10000);
    });

    document.getElementById("form-baixa").addEventListener("submit", async (e) => {
      e.preventDefault();
      const codigo = document.getElementById("codigo").value;
      if (!codigo) return;

      const formData = new FormData();
      formData.append("codigo", codigo);

      const res = await fetch("/scan", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      if (data.success) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="py-2 px-4">${data.hora}</td><td class="py-2 px-4">${data.item}</td>`;
        document.getElementById("tabela-itens").appendChild(tr);
      } else {
        alert(data.mensagem);
      }

      document.getElementById("codigo").value = "";
    });

    document.getElementById("gerar-relatorio").addEventListener("click", async () => {
      const res = await fetch("/gerar_relatorio", { method: "POST" });
      const data = await res.json();
      if (data.success) {
        alert("Relatório gerado com sucesso.");
      } else {
        alert(data.mensagem);
      }
    });
  </script>
</body>
</html>
